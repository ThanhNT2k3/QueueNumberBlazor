@page "/counter/counter-display"
@layout Layout.CounterLayout
@rendermode InteractiveServer
@inject ITicketService TicketService
@inject ICounterService CounterService
@inject QMS.Web.Services.AuthenticationStateService AuthState
@inject NavigationManager Navigation
@inject ILogger<Counter_Display> Logger
@using Microsoft.AspNetCore.SignalR.Client
@using QMS.Domain.Interfaces
@using QMS.Domain.Entities
@inject IRepository<Branch> BranchRepository
@inject IRepository<Counter> CounterRepository
@inject Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage.ProtectedLocalStorage ProtectedLocalStore
@inject IServiceScopeFactory ScopeFactory
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<style>
    .counter-display-container {
        background: linear-gradient(135deg, #e0e7ff 0%, #f0f4ff 50%, #fef3c7 100%);
        min-height: calc(100vh - 70px);
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .counter-display-container::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
        border-radius: 50%;
    }

    .counter-display-container::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -5%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(251, 191, 36, 0.1) 0%, transparent 70%);
        border-radius: 50%;
    }

    /* Header Section */
    .display-header {
        background: white;
        border-radius: 20px;
        padding: 1.5rem 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        position: relative;
        z-index: 1;
    }

    .branch-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .branch-logo {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
    }

    .branch-details h4 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
    }

    .branch-details p {
        margin: 0;
        font-size: 14px;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge-display {
        background: #d1fae5;
        color: #065f46;
        padding: 0.5rem 1.25rem;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-badge-display i {
        color: #10b981;
        font-size: 10px;
        animation: pulse-dot 2s ease-in-out infinite;
    }

    /* Main Display Grid */
    .display-grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 2rem;
        position: relative;
        z-index: 1;
    }

    /* Now Serving Section */
    .now-serving-section {
        background: white;
        border-radius: 24px;
        padding: 3rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 500px;
    }

    .serving-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        color: #64748b;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 2rem;
    }

    .serving-label i {
        font-size: 20px;
    }

    .ticket-display {
        font-size: 140px;
        font-weight: 900;
        background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
        margin: 2rem 0;
        letter-spacing: -2px;
        text-shadow: 0 4px 20px rgba(0, 102, 204, 0.2);
    }

    .counter-name-display {
        color: #1e293b;
        font-size: 24px;
        font-weight: 600;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #e2e8f0;
    }

    .empty-serving {
        color: #94a3b8;
    }

    .empty-serving i {
        font-size: 80px;
        margin-bottom: 1.5rem;
        opacity: 0.3;
    }

    .empty-serving h4 {
        font-size: 24px;
        margin-bottom: 1rem;
    }

    .empty-serving p {
        font-size: 16px;
    }

    /* Queue Status Panel */
    .queue-status-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .status-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        text-align: center;
    }

    .status-card-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        color: #64748b;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 1.5rem;
    }

    .status-card-header i {
        font-size: 14px;
    }

    .waiting-count {
        font-size: 72px;
        font-weight: 900;
        background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .waiting-label {
        color: #64748b;
        font-size: 14px;
        font-weight: 600;
        text-transform: capitalize;
    }

    /* Next in Line Section */
    .next-in-line-section {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-height: 400px;
        display: flex;
        flex-direction: column;
    }

    .next-in-line-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #64748b;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .next-in-line-header i {
        font-size: 14px;
    }

    .next-in-line-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .next-in-line-list::-webkit-scrollbar {
        width: 6px;
    }

    .next-in-line-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }

    .next-in-line-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    .next-in-line-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .next-ticket-item {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-left: 4px solid #e2e8f0;
        transition: all 0.3s ease;
    }

    .next-ticket-item:hover {
        background: #f1f5f9;
        border-left-color: #0066cc;
        transform: translateX(4px);
    }

    .next-ticket-number {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
    }

    .next-ticket-time {
        background: #e0e7ff;
        color: #4338ca;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
    }

    .empty-next-list {
        text-align: center;
        padding: 2rem 1rem;
        color: #cbd5e1;
    }

    .empty-next-list i {
        font-size: 48px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-next-list p {
        margin: 0;
        font-size: 14px;
        font-weight: 500;
    }

    /* Setup Screen Styles */
    .setup-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #e0e7ff 0%, #f0f4ff 50%, #fef3c7 100%);
    }
    
    .setup-card {
        background: white;
        border-radius: 24px;
        padding: 3rem;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    .setup-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 32px;
        margin: 0 auto 1.5rem;
    }

    /* Responsive Design */
    @@media (max-width: 1200px) {
        .display-grid {
            grid-template-columns: 1fr;
        }

        .queue-status-panel {
            grid-template-columns: repeat(2, 1fr);
            display: grid;
        }

        .next-in-line-section {
            grid-column: 1 / -1;
        }
    }

    @@media (max-width: 768px) {
        .ticket-display {
            font-size: 100px;
        }

        .waiting-count {
            font-size: 56px;
        }

        .queue-status-panel {
            grid-template-columns: 1fr;
        }
    }
    @@keyframes flash {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.1); }
        100% { opacity: 1; transform: scale(1); }
    }

    .ticket-display.flash {
        animation: flash 1s ease-in-out 3;
    }
</style>

@if (counter != null)
{
    <div class="counter-display-container">
        <!-- Header -->
        <div class="display-header">
            <div class="d-flex justify-content-between align-items-center">
                <div class="branch-info">
                    <div class="branch-logo">
                        <i class="bi bi-bank2"></i>
                    </div>
                    <div class="branch-details">
                        <h4>Standard Chartered</h4>
                        <p>@(counter?.Name ?? "Counter Display")</p>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <!-- Audio Device Selector -->
                    <div class="audio-selector">
                        <select id="audioDeviceSelect" class="form-select form-select-sm" style="min-width: 200px; border-radius: 8px;">
                            <option value="">üîä Default Speaker</option>
                        </select>
                    </div>
                    <div class="status-badge-display @(counter?.Status == CounterStatus.Busy ? "bg-warning text-dark" : counter?.Status == CounterStatus.Offline ? "bg-secondary text-white" : "")">
                        <i class="bi bi-circle-fill @(counter?.Status == CounterStatus.Busy ? "text-danger" : counter?.Status == CounterStatus.Offline ? "text-white" : "")"></i>
                        <span>@(counter?.Status.ToString().ToUpper() ?? "OFFLINE")</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Display Grid -->
        <div class="display-grid">
            <!-- Now Serving Section -->
            <div class="now-serving-section">
                @if (currentTicket != null)
                {
                    <div class="serving-label">
                        <i class="bi bi-megaphone"></i>
                        <span>Now Serving</span>
                    </div>
                    <div class="ticket-display @(isFlashing ? "flash" : "")">@currentTicket.TicketNumber</div>
                    <div class="counter-name-display">
                        <i class="bi bi-shop me-2"></i>
                        @counter?.Name
                    </div>
                }
                else
                {
                    <div class="empty-serving">
                        <i class="bi bi-cup-hot"></i>
                        <h4>No Customer Being Served</h4>
                        <p>Waiting for next customer...</p>
                    </div>
                }
            </div>

            <!-- Queue Status Panel -->
            <div class="queue-status-panel">
                <!-- Waiting Count Card -->
                <div class="status-card">
                    <div class="status-card-header">
                        <i class="bi bi-people"></i>
                        <span>Queue Status</span>
                    </div>
                    <div class="waiting-count">@(waitingTickets?.Count() ?? 0)</div>
                    <div class="waiting-label">Customers</div>
                </div>

                <!-- Next in Line Section -->
                <div class="next-in-line-section">
                    <div class="next-in-line-header">
                        <i class="bi bi-list-ol"></i>
                        <span>Next in Line</span>
                    </div>
                    <div class="next-in-line-list">
                        @if (waitingTickets == null)
                        {
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-hourglass-split"></i>
                                <p class="mb-0 mt-2">Loading...</p>
                            </div>
                        }
                        else if (!waitingTickets.Any())
                        {
                            <div class="empty-next-list">
                                <i class="bi bi-inbox"></i>
                                <p>No customers waiting</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var ticket in waitingTickets.Take(10))
                            {
                                <div class="next-ticket-item">
                                    <div class="next-ticket-number">@ticket.TicketNumber</div>
                                    <div class="next-ticket-time">@ticket.CreatedAt.ToLocalTime().ToString("HH:mm")</div>
                                </div>
                            }
                            @if (waitingTickets.Count() > 10)
                            {
                                <div class="text-center mt-2 text-muted small">
                                    +@(waitingTickets.Count() - 10) more waiting
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="setup-container">
        <div class="setup-card">
            <div class="setup-icon">
                <i class="bi bi-tv"></i>
            </div>
            <h2 class="fw-bold mb-2">Display Setup</h2>
            <p class="text-muted mb-4">Select a counter to display</p>
            
            @if (branches != null)
            {
                <div class="mb-3 text-start">
                    <label class="form-label fw-semibold">Branch</label>
                    <select class="form-select form-select-lg" @bind="selectedBranchId" @bind:after="OnBranchSelected">
                        <option value="0">Select Branch</option>
                        @foreach (var branch in branches)
                        {
                            <option value="@branch.Id">@branch.Name</option>
                        }
                    </select>
                </div>
            }
            
            @if (availableCounters != null)
            {
                <div class="mb-4 text-start">
                    <label class="form-label fw-semibold">Counter</label>
                    <select class="form-select form-select-lg" @bind="selectedCounterId">
                        <option value="0">Select Counter</option>
                        @foreach (var c in availableCounters)
                        {
                            <option value="@c.Id">@c.Name (@c.Prefix)</option>
                        }
                    </select>
                </div>
                
                <button class="btn btn-primary btn-lg w-100" @onclick="StartDisplay" disabled="@(selectedCounterId == 0)">
                    Start Display
                </button>
            }
        </div>
    </div>
}

<script>
    let selectedAudioDeviceId = '';
    let audioContext = null;

    // Load audio devices and populate dropdown
    async function loadAudioDevices() {
        try {
            // Request permission first
            await navigator.mediaDevices.getUserMedia({ audio: true });
            
            const devices = await navigator.mediaDevices.enumerateDevices();
            const audioOutputs = devices.filter(device => device.kind === 'audiooutput');
            
            const select = document.getElementById('audioDeviceSelect');
            if (!select) return;
            
            // Clear existing options except default
            select.innerHTML = '<option value="">üîä Default Speaker</option>';
            
            // Add all audio output devices
            audioOutputs.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = `üîä ${device.label || 'Speaker ' + (select.options.length)}`;
                select.appendChild(option);
            });
            
            // Load saved preference
            const saved = localStorage.getItem('qms_audio_device');
            if (saved) {
                select.value = saved;
                selectedAudioDeviceId = saved;
            }
            
            // Listen for changes
            select.addEventListener('change', (e) => {
                selectedAudioDeviceId = e.target.value;
                localStorage.setItem('qms_audio_device', selectedAudioDeviceId);
                console.log('Audio device changed to:', selectedAudioDeviceId || 'default');
            });
            
        } catch (err) {
            console.warn('Could not enumerate audio devices:', err);
        }
    }

    // Call on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAudioDevices);
    } else {
        loadAudioDevices();
    }

    window.playAnnouncement = async (text) => {
        console.log("Announcement requested:", text);

        // 1. Play Ding Sound (Web Audio API)
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                // Create or reuse audio context
                if (!audioContext) {
                    audioContext = new AudioContext();
                }
                
                const ctx = audioContext;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                // Set audio output device if supported
                if (selectedAudioDeviceId && ctx.destination.setSinkId) {
                    try {
                        await ctx.destination.setSinkId(selectedAudioDeviceId);
                        console.log('Audio context output set to:', selectedAudioDeviceId);
                    } catch (e) {
                        console.warn('Could not set audio output:', e);
                    }
                }
                
                // Ding-Dong effect
                osc.type = 'sine';
                osc.frequency.setValueAtTime(660, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
                
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
                
                osc.start();
                osc.stop(ctx.currentTime + 1);
            }
        } catch (e) {
            console.error("Audio context error:", e);
        }

        // 2. Text to Speech
        if ('speechSynthesis' in window) {
            const speak = () => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                utterance.rate = 0.8;
                
                const voices = window.speechSynthesis.getVoices();
                // Prefer Google Vietnamese if available
                const vnVoice = voices.find(v => v.lang.includes('vi') && v.name.includes('Google')) || 
                                voices.find(v => v.lang.includes('vi'));
                
                if (vnVoice) {
                    utterance.voice = vnVoice;
                    console.log("Using voice:", vnVoice.name);
                }
                
                window.speechSynthesis.speak(utterance);
            };

            if (window.speechSynthesis.getVoices().length === 0) {
                window.speechSynthesis.addEventListener('voiceschanged', speak, { once: true });
            } else {
                setTimeout(speak, 600); // Wait for ding
            }
        }
    };
</script>

@code {
    private Counter? counter;
    private Ticket? currentTicket;
    private IEnumerable<Ticket>? waitingTickets;
    private HubConnection? hubConnection;
    private bool isFlashing = false;
    
    // Setup vars
    private IEnumerable<Branch>? branches;
    private IEnumerable<Counter>? availableCounters;
    private int selectedBranchId = 0;
    private int selectedCounterId = 0;

    public class SessionData
    {
        public int UserId { get; set; }
        public string UserName { get; set; } = "";
        public string UserRole { get; set; } = "";
        public int CounterId { get; set; }
        public int BranchId { get; set; }
        public string? BranchName { get; set; }
    }
    
    private async Task OnBranchSelected()
    {
        if (selectedBranchId > 0)
        {
            availableCounters = await CounterRepository.FindAsync(c => c.BranchId == selectedBranchId && c.IsActive);
        }
        else
        {
            availableCounters = null;
            selectedCounterId = 0;
        }
    }
    
    private async Task StartDisplay()
    {
        if (selectedCounterId > 0)
        {
            counter = await CounterService.GetCounterByIdAsync(selectedCounterId);
            if (counter != null)
            {
                // Save session for F5 persistence
                var session = new SessionData
                {
                    CounterId = counter.Id,
                    BranchId = counter.BranchId,
                    UserRole = "Display",
                    UserName = counter.Name
                };
                await ProtectedLocalStore.SetAsync("user_session", session);

                await LoadData();
                // Manually trigger SignalR setup since OnAfterRenderAsync might have already run
                await SetupSignalR();
                StateHasChanged();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // 1. Try to get counter from authenticated user (Memory State)
        if (AuthState.CounterId.HasValue)
        {
            counter = await CounterService.GetCounterByIdAsync(AuthState.CounterId.Value);
            if (counter != null)
            {
                await LoadData();
                return;
            }
        }
        
        // 2. If no counter found, load branches for setup
        if (counter == null)
        {
            branches = await BranchRepository.GetAllAsync();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
             // Try to restore from LocalStorage (Persistent State) if not already loaded
             if (counter == null)
             {
                try
                {
                    var result = await ProtectedLocalStore.GetAsync<SessionData>("user_session");
                    if (result.Success && result.Value != null)
                    {
                        var session = result.Value;
                        // Restore AuthState (Optional, but good for consistency)
                        AuthState.Login(session.UserId, session.UserName, session.UserRole, session.CounterId, session.BranchId, session.BranchName);
                        
                        counter = await CounterService.GetCounterByIdAsync(session.CounterId);
                        if (counter != null)
                        {
                            await LoadData();
                            StateHasChanged();
                        }
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error restoring session from local storage");
                }
             }
        }

        if (counter != null && hubConnection == null)
        {
            await SetupSignalR();
        }
    }
    
    private async Task SetupSignalR()
    {
        if (hubConnection != null || counter == null) return;
        
        try
        {
            // Setup SignalR connection
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/qmshub"))
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<int>("TicketUpdated", async (counterId) =>
            {
                Logger.LogInformation("[Display] TicketUpdated received for {CounterId}", counterId);
                if (counterId == counter.Id)
                {
                    await InvokeAsync(async () =>
                    {
                        Logger.LogInformation("[Display] Reloading data for ticket update...");
                        await Task.Delay(200); // Wait for DB propagation
                        await LoadData();
                        
                        // Trigger flash animation
                        isFlashing = true;
                        StateHasChanged();
                        
                        // Play sound
                        if (currentTicket != null)
                        {
                            string text = $"M·ªùi s·ªë {currentTicket.TicketNumber} ƒë·∫øn {counter.Name}";
                            await JSRuntime.InvokeVoidAsync("playAnnouncement", text);
                        }

                        await Task.Delay(3000);
                        isFlashing = false;
                        StateHasChanged();
                    });
                }
            });

            hubConnection.On<int>("CounterUpdated", async (counterId) =>
            {
                Logger.LogInformation("[Display] CounterUpdated received for {CounterId}", counterId);
                if (counterId == counter.Id)
                {
                    await InvokeAsync(async () =>
                    {
                        counter = await CounterService.GetCounterByIdAsync(counterId);
                        await LoadData();
                        StateHasChanged();
                    });
                }
            });

            hubConnection.On<int, string>("CounterStatusChanged", async (counterId, status) =>
            {
                Logger.LogInformation("[Display] CounterStatusChanged received for {CounterId}, Status: {Status}", counterId, status);
                if (counterId == counter.Id)
                {
                    await InvokeAsync(async () =>
                    {
                        Logger.LogInformation("[Display] Updating status to {Status}", status);
                        // Reload the entire counter to ensure all properties are up to date
                        counter = await CounterService.GetCounterByIdAsync(counterId);
                        Logger.LogInformation("[Display] Counter reloaded. New status: {Status}", counter?.Status);
                        StateHasChanged();
                    });
                }
            });

            await hubConnection.StartAsync();
            Logger.LogInformation("[Display] Connected to SignalR. Joining group counter_{CounterId}", counter.Id);
            await hubConnection.InvokeAsync("JoinCounterGroup", counter.Id);
            Logger.LogInformation("[Display] Successfully joined counter_{CounterId}", counter.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error connecting to SignalR: {Message}", ex.Message);
        }
    }

    private async Task LoadData()
    {
        if (counter != null)
        {
            using (var scope = ScopeFactory.CreateScope())
            {
                var scopedCounterService = scope.ServiceProvider.GetRequiredService<ICounterService>();
                var scopedTicketService = scope.ServiceProvider.GetRequiredService<ITicketService>();

                // Reload counter to get latest status
                var freshCounter = await scopedCounterService.GetCounterByIdAsync(counter.Id);
                
                if (freshCounter != null)
                {
                    counter = freshCounter;
                    
                    // Get current serving ticket
                    if (counter.CurrentTicketId.HasValue)
                    {
                        currentTicket = await scopedTicketService.GetTicketByIdAsync(counter.CurrentTicketId.Value);
                    }
                    else
                    {
                        currentTicket = null;
                    }

                    // Get waiting tickets for this counter's branch
                    waitingTickets = await scopedTicketService.GetWaitingTicketsAsync(counter.BranchId, counter.Id);
                }
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            if (counter != null)
            {
                await hubConnection.InvokeAsync("LeaveCounterGroup", counter.Id);
            }
            await hubConnection.DisposeAsync();
        }
    }
}
