@page "/tm/staff"
@rendermode InteractiveServer
@layout Layout.TMLayout
@inject QMS.Domain.Interfaces.IRepository<QMS.Domain.Entities.User> UserRepository
@inject QMS.Domain.Interfaces.IRepository<QMS.Domain.Entities.Branch> BranchRepository
@inject QMS.Domain.Interfaces.IUnitOfWork UnitOfWork
@inject QMS.Web.Services.AuthenticationStateService AuthState
@inject NavigationManager Navigation
@inject QMS.Application.Interfaces.IQmsNotificationService NotificationService

<div class="staff-management-container">
    <!-- Header -->
    <PageHeader Title="Staff Management" 
                Subtitle="Manage staff members in your branch"
                Icon="bi bi-people-fill" />
    
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <div class="staff-stats">
            <div class="stat-item">
                <i class="bi bi-people-fill"></i>
                <span class="stat-number">@(staffList?.Count ?? 0)</span>
                <span class="stat-label">Total Staff</span>
            </div>
            <div class="stat-item">
                <i class="bi bi-person-badge"></i>
                <span class="stat-number">@(staffList?.Count(s => s.Role == "Teller") ?? 0)</span>
                <span class="stat-label">Tellers</span>
            </div>
        </div>
        <BaseButton Variant="primary" 
                   OnClick="ShowAddStaffModal"
                   Icon="bi bi-plus-circle">
            Add Staff
        </BaseButton>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading staff members...</p>
        </div>
    }
    else if (staffList != null && staffList.Any())
    {
        <div class="staff-grid">
            @foreach (var staff in staffList)
            {
                <div class="staff-card">
                    <div class="staff-card-header">
                        <UserAvatar FullName="@staff.FullName" Size="lg" />
                        <div class="staff-header-info">
                            <h5 class="staff-name">@staff.FullName</h5>
                            <span class="role-badge role-@staff.Role.ToLower()">
                                @GetRoleDisplayName(staff.Role)
                            </span>
                        </div>
                    </div>
                    <div class="staff-card-body">
                        <div class="staff-info-item">
                            <div class="info-icon">
                                <i class="bi bi-envelope-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Email</span>
                                <span class="info-value">@staff.Email</span>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(staff.PhoneNumber))
                        {
                            <div class="staff-info-item">
                                <div class="info-icon">
                                    <i class="bi bi-telephone-fill"></i>
                                </div>
                                <div class="info-content">
                                    <span class="info-label">Phone</span>
                                    <span class="info-value">@staff.PhoneNumber</span>
                                </div>
                            </div>
                        }
                        <div class="staff-info-item">
                            <div class="info-icon">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Branch</span>
                                <span class="info-value">@(branches?.FirstOrDefault(b => b.Id == staff.CurrentBranchId)?.Name ?? "N/A")</span>
                            </div>
                        </div>
                    </div>
                    <div class="staff-card-footer">
                        <BaseButton Variant="outline-primary" 
                                   Size="sm"
                                   OnClick="() => EditStaff(staff)"
                                   Icon="bi bi-pencil">
                            Edit
                        </BaseButton>
                        <BaseButton Variant="outline-danger" 
                                   Size="sm"
                                   OnClick="() => ConfirmDeleteStaff(staff)"
                                   Icon="bi bi-trash">
                            Delete
                        </BaseButton>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="bi bi-people"></i>
            </div>
            <h4>No Staff Members Yet</h4>
            <p>Get started by adding your first staff member to the system</p>
            <BaseButton Variant="primary" 
                       OnClick="ShowAddStaffModal"
                       Icon="bi bi-plus-circle">
                Add Your First Staff
            </BaseButton>
        </div>
    }
</div>

<!-- Add/Edit Staff Modal -->
<BaseModal @bind-IsOpen="showStaffModal" 
          Title="@(editingStaff?.Id > 0 ? "Edit Staff Member" : "Add New Staff Member")" 
          Size="md"
          OnClose="CloseStaffModal">
    <HeaderContent>
        <i class="bi bi-person-plus me-2"></i>
        @(editingStaff?.Id > 0 ? "Edit Staff Member" : "Add New Staff Member")
    </HeaderContent>
    <BodyContent>
        <div class="form-section">
            <BaseInput Label="Full Name" 
                      @bind-Value="editingStaff.FullName"
                      Placeholder="Enter full name" />
            
            <BaseInput Label="Email Address" 
                      Type="email"
                      @bind-Value="editingStaff.Email"
                      Placeholder="email@example.com" />
            
            <BaseInput Label="Phone Number" 
                      Type="tel"
                      @bind-Value="editingStaff.PhoneNumber"
                      Placeholder="0901234567" />
            
            <BaseSelect Label="Role" @bind-Value="selectedRole">
                <option value="Teller">Teller</option>
                <option value="TM">Transaction Manager</option>
                <option value="Manager">Manager</option>
            </BaseSelect>
            
            <BaseSelect Label="Branch" @bind-Value="selectedBranchId">
                <option value="">Select Branch</option>
                @if (branches != null)
                {
                    @foreach (var branch in branches)
                    {
                        <option value="@branch.Id">@branch.Name</option>
                    }
                }
            </BaseSelect>
        </div>
    </BodyContent>
    <FooterContent>
        <BaseButton Variant="secondary" OnClick="CloseStaffModal" Icon="bi bi-x-lg">
            Cancel
        </BaseButton>
        <BaseButton Variant="primary" OnClick="SaveStaff" Icon="bi bi-check-lg">
            @(editingStaff?.Id > 0 ? "Update Staff" : "Add Staff")
        </BaseButton>
    </FooterContent>
</BaseModal>

<!-- Delete Confirmation Modal -->
<BaseModal @bind-IsOpen="showDeleteModal" 
          Title="Confirm Delete" 
          Size="sm"
          OnClose="CancelDelete">
    <HeaderContent>
        <i class="bi bi-exclamation-triangle text-danger me-2"></i>
        Confirm Delete
    </HeaderContent>
    <BodyContent>
        <div class="text-center py-3">
            <div class="delete-icon mb-3">
                <i class="bi bi-trash"></i>
            </div>
            <h5>Delete @staffToDelete?.FullName?</h5>
            <p class="text-muted mb-0">This action cannot be undone. Are you sure you want to delete this staff member?</p>
        </div>
    </BodyContent>
    <FooterContent>
        <BaseButton Variant="secondary" OnClick="CancelDelete">
            Cancel
        </BaseButton>
        <BaseButton Variant="danger" OnClick="ConfirmDelete" Icon="bi bi-trash">
            Delete Staff
        </BaseButton>
    </FooterContent>
</BaseModal>

<style>
    .staff-management-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Stats Section */
    .staff-stats {
        display: flex;
        gap: 2rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .stat-item i {
        font-size: 1.5rem;
        color: #667eea;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    /* Staff Grid */
    .staff-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
        gap: 1.5rem;
    }

    .staff-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
    }

    .staff-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
    }

    .staff-card-header {
        padding: 1.75rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        display: flex;
        align-items: center;
        gap: 1.25rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .staff-header-info {
        flex: 1;
    }

    .staff-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }

    .role-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .role-badge.role-teller {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
    }

    .role-badge.role-tm {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
    }

    .role-badge.role-manager {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .staff-card-body {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .staff-info-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 10px;
        transition: all 0.2s;
    }

    .staff-info-item:hover {
        background: #f1f5f9;
    }

    .info-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .info-icon i {
        color: white;
        font-size: 0.875rem;
    }

    .info-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        flex: 1;
        min-width: 0;
    }

    .info-label {
        font-size: 0.6875rem;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
        word-break: break-word;
    }

    .staff-card-footer {
        padding: 1.25rem 1.5rem;
        background: #f8fafc;
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        border-top: 1px solid #e2e8f0;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    .empty-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-icon i {
        font-size: 3.5rem;
        color: #cbd5e1;
    }

    .empty-state h4 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.75rem;
    }

    .empty-state p {
        color: #64748b;
        font-size: 1rem;
        margin-bottom: 2rem;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Form Section */
    .form-section {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    /* Delete Modal */
    .delete-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto;
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .delete-icon i {
        font-size: 2rem;
        color: #dc2626;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .staff-stats {
            flex-direction: column;
            gap: 1rem;
        }

        .staff-grid {
            grid-template-columns: 1fr;
        }

        .mb-4.d-flex {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch !important;
        }
    }
</style>

@code {
    private List<QMS.Domain.Entities.User>? staffList;
    private List<QMS.Domain.Entities.Branch>? branches;
    private bool isLoading = true;
    private bool showStaffModal = false;
    private bool showDeleteModal = false;
    private QMS.Domain.Entities.User editingStaff = new();
    private QMS.Domain.Entities.User? staffToDelete;
    private string selectedRole = "Teller";
    private string selectedBranchId = "";

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated || AuthState.UserRole != "TM")
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        
        branches = (await BranchRepository.GetAllAsync()).ToList();
        
        if (AuthState.BranchId.HasValue)
        {
            var allUsers = await UserRepository.GetAllAsync();
            staffList = allUsers.Where(u => u.CurrentBranchId == AuthState.BranchId.Value).ToList();
        }
        
        isLoading = false;
    }

    private void ShowAddStaffModal()
    {
        editingStaff = new QMS.Domain.Entities.User 
        { 
            CurrentBranchId = AuthState.BranchId ?? 0,
            Role = "Teller"
        };
        selectedRole = "Teller";
        selectedBranchId = (AuthState.BranchId ?? 0).ToString();
        showStaffModal = true;
    }

    private void EditStaff(QMS.Domain.Entities.User staff)
    {
        editingStaff = new QMS.Domain.Entities.User
        {
            Id = staff.Id,
            FullName = staff.FullName,
            Email = staff.Email,
            PhoneNumber = staff.PhoneNumber,
            Role = staff.Role,
            CurrentBranchId = staff.CurrentBranchId
        };
        selectedRole = staff.Role;
        selectedBranchId = staff.CurrentBranchId.ToString();
        showStaffModal = true;
    }

    private async Task SaveStaff()
    {
        if (string.IsNullOrWhiteSpace(editingStaff.FullName) || 
            string.IsNullOrWhiteSpace(editingStaff.Email))
        {
            return;
        }

        // Update from select bindings
        editingStaff.Role = selectedRole;
        if (int.TryParse(selectedBranchId, out int branchId))
        {
            editingStaff.CurrentBranchId = branchId;
        }

        if (editingStaff.Id > 0)
        {
            var existing = await UserRepository.GetByIdAsync(editingStaff.Id);
            if (existing != null)
            {
                existing.FullName = editingStaff.FullName;
                existing.Email = editingStaff.Email;
                existing.PhoneNumber = editingStaff.PhoneNumber;
                existing.Role = editingStaff.Role;
                existing.CurrentBranchId = editingStaff.CurrentBranchId;
                await UserRepository.UpdateAsync(existing);
            }
        }
        else
        {
            await UserRepository.AddAsync(editingStaff);
        }

        await UnitOfWork.SaveChangesAsync();
        await LoadData();
        CloseStaffModal();
    }

    private void ConfirmDeleteStaff(QMS.Domain.Entities.User staff)
    {
        staffToDelete = staff;
        showDeleteModal = true;
    }

    private async Task ConfirmDelete()
    {
        if (staffToDelete != null && staffToDelete.Id > 0)
        {
            var existing = await UserRepository.GetByIdAsync(staffToDelete.Id);
            if (existing != null)
            {
                await UserRepository.DeleteAsync(existing);
                await UnitOfWork.SaveChangesAsync();
                await LoadData();
            }
        }
        CancelDelete();
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        staffToDelete = null;
    }

    private void CloseStaffModal()
    {
        showStaffModal = false;
        editingStaff = new();
        selectedRole = "Teller";
        selectedBranchId = "";
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "U";
        var parts = name.Split(' ');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }

    private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            "TM" => "bg-purple text-white",
            "Teller" => "bg-info text-dark",
            "Manager" => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
    }

    private string GetRoleDisplayName(string role)
    {
        return role switch
        {
            "TM" => "Transaction Manager",
            "Teller" => "Teller",
            "Manager" => "Manager",
            _ => role
        };
    }
}
