@page "/tm/services"
@rendermode InteractiveServer
@layout Layout.TMLayout
@inject QMS.Domain.Interfaces.IRepository<QMS.Domain.Entities.ServiceType> ServiceTypeRepository
@inject QMS.Domain.Interfaces.IUnitOfWork UnitOfWork
@inject QMS.Web.Services.AuthenticationStateService AuthState
@inject NavigationManager Navigation

<div class="service-management-container">
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1">
                    <i class="bi bi-grid-3x3-gap-fill me-2"></i>
                    Service Management
                </h2>
                <p class="text-muted mb-0">Manage service types available in your branch</p>
            </div>
            <button class="btn btn-primary" @onclick="ShowAddServiceModal">
                <i class="bi bi-plus-circle me-2"></i>
                Add Service
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (serviceList != null && serviceList.Any())
    {
        <div class="row g-3">
            @foreach (var service in serviceList)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="service-card">
                        <div class="service-card-header" style="background: @service.ColorCode">
                            <div class="service-icon">
                                <i class="bi @service.IconClass"></i>
                            </div>
                        </div>
                        <div class="service-card-body">
                            <h5 class="service-name">@service.Name</h5>
                            <p class="service-code">Code: @service.Code</p>
                            @if (!string.IsNullOrEmpty(service.Description))
                            {
                                <p class="service-description">@service.Description</p>
                            }
                            <div class="service-meta">
                                <span class="badge @(service.IsActive ? "bg-success" : "bg-secondary")">
                                    @(service.IsActive ? "Active" : "Inactive")
                                </span>
                            </div>
                        </div>
                        <div class="service-card-footer">
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => EditService(service)">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm @(service.IsActive ? "btn-outline-warning" : "btn-outline-success")" 
                                    @onclick="() => ToggleServiceStatus(service)">
                                <i class="bi @(service.IsActive ? "bi-pause" : "bi-play")"></i> 
                                @(service.IsActive ? "Deactivate" : "Activate")
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-grid-3x3-gap"></i>
            <h4>No Services</h4>
            <p>Click "Add Service" to create your first service type</p>
        </div>
    }
</div>

@* Add/Edit Service Modal *@
@if (showServiceModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5); z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingService?.Id > 0 ? "Edit Service" : "Add New Service")</h5>
                    <button type="button" class="btn-close" @onclick="CloseServiceModal"></button>
                </div>
                <div class="modal-body">
                    <!-- Preview -->
                    <div class="mb-4 text-center">
                        <div class="service-preview-card" style="background: @editingService.ColorCode">
                            <div class="service-preview-icon">
                                <i class="bi @editingService.IconClass"></i>
                            </div>
                        </div>
                        <small class="text-muted">Preview</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Name</label>
                                <input type="text" class="form-control" @bind="editingService.Name" placeholder="e.g., Account Opening" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Code</label>
                                <input type="text" class="form-control" @bind="editingService.Code" placeholder="e.g., ACC_OPEN" />
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" rows="2" @bind="editingService.Description" 
                                  placeholder="Brief description of the service"></textarea>
                    </div>

                    <!-- Icon Picker -->
                    <div class="mb-3">
                        <label class="form-label">Choose Icon</label>
                        <div class="icon-picker">
                            @foreach (var icon in availableIcons)
                            {
                                <div class="icon-option @(editingService.IconClass == icon ? "selected" : "")" 
                                     @onclick="() => editingService.IconClass = icon">
                                    <i class="bi @icon"></i>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Color Picker -->
                    <div class="mb-3">
                        <label class="form-label">Choose Color</label>
                        <div class="color-picker">
                            @foreach (var color in availableColors)
                            {
                                <div class="color-option @(editingService.ColorCode == color.Value ? "selected" : "")" 
                                     style="background: @color.Value"
                                     @onclick="() => editingService.ColorCode = color.Value"
                                     title="@color.Key">
                                    @if (editingService.ColorCode == color.Value)
                                    {
                                        <i class="bi bi-check-lg"></i>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" @bind="editingService.IsActive" />
                        <label class="form-check-label" for="isActive">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseServiceModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveService">Save</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .service-management-container {
        padding: 2rem;
    }

    .service-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .service-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .service-card-header {
        padding: 2rem;
        text-align: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .service-icon {
        width: 80px;
        height: 80px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        color: white;
        font-size: 2rem;
    }

    .service-card-body {
        padding: 1.5rem;
    }

    .service-name {
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #1e293b;
    }

    .service-code {
        color: #64748b;
        font-size: 0.85rem;
        font-family: monospace;
        margin-bottom: 0.75rem;
    }

    .service-description {
        color: #64748b;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .service-meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .service-card-footer {
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        display: flex;
        gap: 0.5rem;
        justify-content: space-between;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #94a3b8;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .empty-state h4 {
        margin-bottom: 0.5rem;
    }

    /* Icon and Color Picker Styles */
    .service-preview-card {
        display: inline-block;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 0.5rem;
    }

    .service-preview-icon {
        width: 80px;
        height: 80px;
        background: rgba(255,255,255,0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2.5rem;
        margin: 0 auto;
    }

    .icon-picker {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
    }

    .icon-option {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.5rem;
        color: #64748b;
    }

    .icon-option:hover {
        border-color: #667eea;
        background: #f8f9fa;
        transform: scale(1.05);
    }

    .icon-option.selected {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }

    .color-picker {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 0.5rem;
    }

    .color-option {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        border: 3px solid transparent;
    }

    .color-option:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .color-option.selected {
        border-color: white;
        box-shadow: 0 0 0 2px #667eea;
    }
</style>

@code {
    private List<QMS.Domain.Entities.ServiceType>? serviceList;
    private bool isLoading = true;
    private bool showServiceModal = false;
    private QMS.Domain.Entities.ServiceType editingService = new();

    // Available icons (Bootstrap Icons)
    private List<string> availableIcons = new()
    {
        "bi-cash-coin",      // Deposit/Withdrawal
        "bi-credit-card",    // Card services
        "bi-bank",           // Loan
        "bi-person-badge",   // Account
        "bi-arrow-left-right", // Transfer
        "bi-wallet2",        // Wallet
        "bi-graph-up-arrow", // Investment
        "bi-shield-check",   // Insurance
        "bi-star-fill",      // VIP
        "bi-briefcase",      // Business
        "bi-house-door",     // Mortgage
        "bi-car-front",      // Auto loan
        "bi-piggy-bank",     // Savings
        "bi-currency-exchange", // Exchange
        "bi-receipt",        // Payment
        "bi-file-earmark-text" // Documents
    };

    // Available colors
    private Dictionary<string, string> availableColors = new()
    {
        { "Blue Purple", "#667eea" },
        { "Pink Red", "#f093fb" },
        { "Cyan Blue", "#4facfe" },
        { "Green Mint", "#43e97b" },
        { "Pink Yellow", "#fa709a" },
        { "Teal Purple", "#30cfd0" },
        { "Orange", "#ff6b6b" },
        { "Emerald", "#10b981" },
        { "Violet", "#8b5cf6" },
        { "Amber", "#f59e0b" }
    };

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated || AuthState.UserRole != "TM")
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        serviceList = (await ServiceTypeRepository.GetAllAsync()).OrderBy(s => s.Name).ToList();
        isLoading = false;
    }

    private void ShowAddServiceModal()
    {
        editingService = new QMS.Domain.Entities.ServiceType 
        { 
            IsActive = true
        };
        showServiceModal = true;
    }

    private void EditService(QMS.Domain.Entities.ServiceType service)
    {
        editingService = new QMS.Domain.Entities.ServiceType
        {
            Id = service.Id,
            Name = service.Name,
            Code = service.Code,
            Description = service.Description,
            IsActive = service.IsActive,
            IconClass = service.IconClass,
            ColorCode = service.ColorCode
        };
        showServiceModal = true;
    }

    private async Task SaveService()
    {
        if (string.IsNullOrWhiteSpace(editingService.Name) || 
            string.IsNullOrWhiteSpace(editingService.Code))
        {
            return;
        }

        if (editingService.Id > 0)
        {
            var existing = await ServiceTypeRepository.GetByIdAsync(editingService.Id);
            if (existing != null)
            {
                existing.Name = editingService.Name;
                existing.Code = editingService.Code;
                existing.Description = editingService.Description;
                existing.IsActive = editingService.IsActive;
                existing.IconClass = editingService.IconClass;
                existing.ColorCode = editingService.ColorCode;
                await ServiceTypeRepository.UpdateAsync(existing);
            }
        }
        else
        {
            await ServiceTypeRepository.AddAsync(editingService);
        }

        await UnitOfWork.SaveChangesAsync();
        await LoadData();
        CloseServiceModal();
    }

    private async Task ToggleServiceStatus(QMS.Domain.Entities.ServiceType service)
    {
        service.IsActive = !service.IsActive;
        await ServiceTypeRepository.UpdateAsync(service);
        await UnitOfWork.SaveChangesAsync();
        await LoadData();
    }

    private void CloseServiceModal()
    {
        showServiceModal = false;
        editingService = new();
    }

    private string GetServiceColor(string code)
    {
        var hash = code.GetHashCode();
        var colors = new[]
        {
            "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
            "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
            "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
            "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
            "linear-gradient(135deg, #30cfd0 0%, #330867 100%)"
        };
        return colors[Math.Abs(hash) % colors.Length];
    }

    private string GetServiceIcon(string code)
    {
        return code.ToUpper() switch
        {
            var c when c.Contains("ACCOUNT") => "bi-person-badge",
            var c when c.Contains("DEPOSIT") => "bi-cash-coin",
            var c when c.Contains("WITHDRAW") => "bi-wallet2",
            var c when c.Contains("TRANSFER") => "bi-arrow-left-right",
            var c when c.Contains("LOAN") => "bi-bank",
            var c when c.Contains("CARD") => "bi-credit-card",
            _ => "bi-gear"
        };
    }
}
