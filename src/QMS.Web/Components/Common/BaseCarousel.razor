<CascadingValue Value="this">
    <div class="base-carousel @ContainerClass" @onmouseenter="PauseAutoPlay" @onmouseleave="ResumeAutoPlay">
        <!-- Carousel Items -->
        <div class="carousel-track" style="transform: translateX(-@(currentIndex * 100)%)">
            @ChildContent
        </div>

        <!-- Navigation Buttons -->
        @if (ShowControls && itemCount > 1)
        {
            <button class="carousel-control carousel-control-prev" @onclick="Previous" type="button">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="carousel-control carousel-control-next" @onclick="Next" type="button">
                <i class="bi bi-chevron-right"></i>
            </button>
        }

        <!-- Indicators -->
        @if (ShowIndicators && itemCount > 1)
        {
            <div class="carousel-indicators">
                @for (int i = 0; i < itemCount; i++)
                {
                    var index = i;
                    <button class="indicator @(currentIndex == index ? "active" : "")" 
                            @onclick="() => GoToSlide(index)"
                            type="button">
                    </button>
                }
            </div>
        }
    </div>
</CascadingValue>

<style>
    .base-carousel {
        position: relative;
        width: 100%;
        overflow: hidden;
        border-radius: 16px;
        background: #f8fafc;
    }

    .carousel-track {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        width: 100%;
        height: 100%;
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
    }

    /* Define carousel-item styles here to ensure they are applied correctly in the flex container */
    ::deep .base-carousel-item {
        flex: 0 0 100%;
        width: 100%;
        min-width: 100%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
    }

    /* Navigation Controls */
    .carousel-control {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .carousel-control:hover {
        background: white;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-control:active {
        transform: translateY(-50%) scale(0.95);
    }

    .carousel-control i {
        font-size: 1.5rem;
        color: #667eea;
    }

    .carousel-control-prev {
        left: 1rem;
    }

    .carousel-control-next {
        right: 1rem;
    }

    /* Indicators */
    .carousel-indicators {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;
        z-index: 10;
    }

    .indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0;
    }

    .indicator:hover {
        background: rgba(255, 255, 255, 0.8);
        transform: scale(1.2);
    }

    .indicator.active {
        width: 32px;
        border-radius: 6px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .carousel-control {
            width: 36px;
            height: 36px;
        }

        .carousel-control i {
            font-size: 1.25rem;
        }

        .carousel-control-prev {
            left: 0.5rem;
        }

        .carousel-control-next {
            right: 0.5rem;
        }

        .indicator {
            width: 8px;
            height: 8px;
        }

        .indicator.active {
            width: 24px;
        }
    }
</style>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public bool AutoPlay { get; set; } = true;
    [Parameter] public int AutoPlayInterval { get; set; } = 5000; // milliseconds
    [Parameter] public bool ShowControls { get; set; } = true;
    [Parameter] public bool ShowIndicators { get; set; } = true;
    [Parameter] public string ContainerClass { get; set; } = "";
    [Parameter] public EventCallback<int> OnSlideChanged { get; set; }

    private int currentIndex = 0;
    private System.Threading.Timer? autoPlayTimer;
    private bool isAutoPlayPaused = false;
    private int itemCount = 0;

    protected override void OnInitialized()
    {
        if (AutoPlay)
        {
            StartAutoPlay();
        }
    }

    // Method for child items to register themselves
    public void RegisterItem()
    {
        itemCount++;
        StateHasChanged();
    }

    private void StartAutoPlay()
    {
        autoPlayTimer = new System.Threading.Timer(async _ =>
        {
            if (!isAutoPlayPaused && itemCount > 1)
            {
                await InvokeAsync(() =>
                {
                    Next();
                    StateHasChanged();
                });
            }
        }, null, AutoPlayInterval, AutoPlayInterval);
    }

    private void PauseAutoPlay()
    {
        isAutoPlayPaused = true;
    }

    private void ResumeAutoPlay()
    {
        isAutoPlayPaused = false;
    }

    private void Next()
    {
        if (itemCount > 0)
        {
            currentIndex = (currentIndex + 1) % itemCount;
            OnSlideChanged.InvokeAsync(currentIndex);
        }
    }

    private void Previous()
    {
        if (itemCount > 0)
        {
            currentIndex = currentIndex == 0 ? itemCount - 1 : currentIndex - 1;
            OnSlideChanged.InvokeAsync(currentIndex);
        }
    }

    private void GoToSlide(int index)
    {
        currentIndex = index;
        OnSlideChanged.InvokeAsync(currentIndex);
    }

    public void Dispose()
    {
        autoPlayTimer?.Dispose();
    }
}
